name: Deploy to Google Compute Engine
run-name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - backend/**
      - .github/workflows/deploy.yml

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.GCE_HOST }} > ~/.ssh/known_hosts

      - name: Sync backend code to GCE
        working-directory: ./backend
        run: |
          rsync -az --delete \
            -e "ssh -i ~/.ssh/id_rsa" \
            ./ ${{ secrets.GCE_USER }}@${{ secrets.GCE_HOST }}:/home/${{ secrets.GCE_USER }}/backend/

      - name: SSH into GCE and deploy backend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.GCE_USER }}@${{ secrets.GCE_HOST }} << 'EOF'
            set -e
            cd /home/${{ secrets.GCE_USER }}/backend

            echo "Installing Python venv..."
            sudo apt update
            sudo apt install -y python3.11-venv

            echo "Setting up virtual environment..."
            python3.11 -m venv venv
            ./venv/bin/pip install --upgrade pip
            ./venv/bin/pip install -r requirements.txt

            echo "Creating .env file..."
            cat <<EOT > .env
DATABASE_URL=${{ secrets.DATABASE_URL }}
URL=${{ secrets.BACKEND_URL }}
CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
FERMION_API_KEY=${{ secrets.FERMION_API_KEY }}
BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
MAIL_SENDER_NAME=${{ secrets.MAIL_SENDER_NAME }}
MAIL_SENDER_EMAIL=${{ secrets.MAIL_SENDER_EMAIL }}
OTP_EXPIRY_DURATION_SECONDS=${{ secrets.OTP_EXPIRY_DURATION_SECONDS }}
GOOGLE_APPLICATION_CREDENTIALS=gcs_service_key.json
GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME }}
FRONTEND_URL=${{ secrets.FRONTEND_URL }}
EOT

            echo '${{ secrets.GCS_SERVICE_KEY }}' > gcs_service_key.json

            echo "Running migrations and restarting backend..."
            ./venv/bin/alembic upgrade head
            sudo systemctl restart gunicorn.service
          EOF
